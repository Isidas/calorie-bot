# Calorie Bot ‚Äî MVP

Telegram-–±–æ—Ç: –ø–æ —Ñ–æ—Ç–æ –±–ª—é–¥–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–ª—é–¥–æ –∏ –ø–æ—Ä—Ü–∏—é (Gemini Vision), –∫–∞–ª–æ—Ä–∏–∏ –∏ –ë–ñ–£ —Å—á–∏—Ç–∞–µ—Ç –ø–æ –±–∞–∑–µ **USDA FoodData Central**. –ë–µ–∑ OpenAI.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
TelegramApp/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ types.ts              # DishVision, DishAnalysis, IVisionProvider
‚îÇ   ‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts          # Telegraf: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ, —Ö–µ–Ω–¥–ª–µ—Ä—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers.ts       # /start, —Ñ–æ—Ç–æ, –Ω–µ-—Ñ–æ—Ç–æ, —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ telegram-retry.ts
‚îÇ   ‚îú‚îÄ‚îÄ ai/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts          # createVisionProvider
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gemini-provider.ts # Gemini Vision + fallback –æ—Ü–µ–Ω–∫–∞ –ë–ñ–£
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îú‚îÄ‚îÄ dish-service.ts   # Vision ‚Üí Nutrition ‚Üí DishAnalysis, rate limit
‚îÇ       ‚îú‚îÄ‚îÄ history.ts        # –¢–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
‚îÇ       ‚îú‚îÄ‚îÄ rate-limit.ts
‚îÇ       ‚îú‚îÄ‚îÄ nutrition/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ usda-client.ts      # USDA FDC: search + food details
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ nutrition-service.ts # –ü–æ–∏—Å–∫ –ø–æ candidates, fallback Gemini
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ README.md
```

## –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å TELEGRAM_BOT_TOKEN

1. –û—Ç–∫—Ä–æ–π Telegram, –Ω–∞–π–¥–∏ [@BotFather](https://t.me/BotFather).
2. –û—Ç–ø—Ä–∞–≤—å `/newbot`, –≤–≤–µ–¥–∏ –∏–º—è –∏ username (–æ–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ `bot`).
3. –°–∫–æ–ø–∏—Ä—É–π –≤—ã–¥–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ `.env`: `TELEGRAM_BOT_TOKEN=...`.

## –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å GEMINI_API_KEY

1. –ó–∞–π–¥–∏ –Ω–∞ [Google AI Studio](https://aistudio.google.com/) (–∏–ª–∏ [Google AI for Developers](https://ai.google.dev/)).
2. –í–æ–π–¥–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç Google, –æ—Ç–∫—Ä–æ–π —Ä–∞–∑–¥–µ–ª **Get API key** / **API Keys**.
3. –°–æ–∑–¥–∞–π API key –∏ —Å–∫–æ–ø–∏—Ä—É–π –µ–≥–æ –≤ `.env`: `GEMINI_API_KEY=...`.

–ú–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `gemini-2.5-flash` (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ). –ï—Å–ª–∏ 404 ‚Äî –∑–∞–¥–∞–π –≤ `.env` –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∏–º—è –ø–æ [—Å–ø–∏—Å–∫—É –º–æ–¥–µ–ª–µ–π](https://ai.google.dev/api/models).

## –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å USDA_API_KEY

1. –ó–∞–π–¥–∏ –Ω–∞ [FoodData Central ‚Äî API Key Signup](https://fdc.nal.usda.gov/api-key-signup.html) (–∏–ª–∏ —á–µ—Ä–µ–∑ [data.gov](https://api.data.gov/signup/) –¥–ª—è –∫–ª—é—á–∞ data.gov ‚Äî FDC –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±–∞).
2. –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É –∏ –ø–æ–ª—É—á–∏ –∫–ª—é—á –ø–æ email.
3. –í—Å—Ç–∞–≤—å –≤ `.env`: `USDA_API_KEY=...`.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–ª—é–¥ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–ª–æ—Ä–∏–π/–ë–ñ–£ –∏–∑ –±–∞–∑—ã USDA (–Ω–∞ 100 –≥, —Ä–∞—Å—á—ë—Ç –Ω–∞ –ø–æ—Ä—Ü–∏—é –≤ –∫–æ–¥–µ).

## –ó–∞–ø—É—Å–∫

1. –°–∫–æ–ø–∏—Ä—É–π `.env.example` –≤ `.env` –∏ –∑–∞–ø–æ–ª–Ω–∏ —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:
   - `TELEGRAM_BOT_TOKEN`
   - `GEMINI_API_KEY`
   - `USDA_API_KEY`

   **–í–∞–∂–Ω–æ:** –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.env` —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (—Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ `.gitignore`). –í Docker –ø—Ä–∏ production –∑–∞–¥–∞—ë—Ç—Å—è `NODE_ENV=production`.

2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫:

```bash
npm install
npm run build
npm start
```

–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

```bash
npm run dev
```

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤ `.env`:
- `GEMINI_MODEL` ‚Äî –º–æ–¥–µ–ª—å Gemini (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `gemini-2.5-flash`).
- `HTTP_TIMEOUT_MS` ‚Äî —Ç–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Gemini –∏ USDA –≤ –º—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30000).
- `ENABLE_GEMINI_FALLBACK` ‚Äî –µ—Å–ª–∏ `true`, –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤ USDA –±–æ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç —É Gemini –æ—Ü–µ–Ω–∫—É –ë–ñ–£ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `false`).

## Deploy to VPS (Docker)

–ó–∞–ø—É—Å–∫ –Ω–∞ Ubuntu (–∏–ª–∏ –¥—Ä—É–≥–æ–º Linux) –±–µ–∑ VPN: —Å–æ–±–µ—Ä–∏ –æ–±—Ä–∞–∑ –∏ –ø–æ–¥–Ω–∏–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ `.env` –Ω–∞ —Ö–æ—Å—Ç–µ.

1. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–∫–ª–æ–Ω–∏—Ä—É–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, —Å–æ–∑–¥–∞–π `.env` (–∫–∞–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ó–∞–ø—É—Å–∫¬ª).

2. –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫:

```bash
docker compose build
docker compose up -d
```

–õ–æ–≥–∏:

```bash
docker compose logs -f bot
```

–û—Å—Ç–∞–Ω–æ–≤–∫–∞:

```bash
docker compose down
```

- –û–±—Ä–∞–∑ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è multi-stage (Node 20 Alpine), –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `node dist/index.js`.
- –î–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π: `docker compose build && docker compose up -d --force-recreate`.

## –ü–æ–≤–µ–¥–µ–Ω–∏–µ

- **/start** ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ.
- **–§–æ—Ç–æ** ‚Äî –±–æ—Ç —Å–∫–∞—á–∏–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Gemini (vision). –ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞, –≤–µ—Å –ø–æ—Ä—Ü–∏–∏ –∏ —Å–ø–∏—Å–æ–∫ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (candidates). –ü–æ –Ω–∏–º –∏—â–µ—Ç –≤ USDA FDC, –±–µ—Ä—ë—Ç –∫–∞–ª–æ—Ä–∏–∏/–ë–ñ–£ –Ω–∞ 100 –≥ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ü–∏—é. –ï—Å–ª–∏ –≤ –±–∞–∑–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É Gemini –æ—Ü–µ–Ω–∫—É –ë–ñ–£ (confidence=low, –≤ –æ—Ç–≤–µ—Ç–µ —É–∫–∞–∑–∞–Ω–æ ¬´–æ—Ü–µ–Ω–∫–∞, —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤ –±–∞–∑–µ –Ω–µ—Ç¬ª). –û—Ç–≤–µ—Ç: –Ω–∞–∑–≤–∞–Ω–∏–µ, –¥–∏–∞–ø–∞–∑–æ–Ω –∫–∞–ª–æ—Ä–∏–π, –ë–ñ–£, –≤–µ—Å, 1‚Äì3 –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è, –¥–∏—Å–∫–ª–µ–π–º–µ—Ä.
- **–ù–µ —Ñ–æ—Ç–æ** ‚Äî –ø—Ä–æ—Å—å–±–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –±–ª—é–¥–∞.
- **Rate limit** ‚Äî –æ–¥–∏–Ω –∞–Ω–∞–ª–∏–∑ —Ä–∞–∑ –≤ 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –û—à–∏–±–∫–∏: –ø—Ä–æ–±–ª–µ–º—ã USDA ‚Üí ¬´–ù–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –±–ª—é–¥–æ –≤ –±–∞–∑–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ –∏–ª–∏ —É–≥–æ–ª.¬ª; –ø—Ä–æ–±–ª–µ–º—ã Gemini/—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è ‚Üí ¬´–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –±–ª—é–¥–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.¬ª

## –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞

```
üçΩ Grilled chicken breast
üìä ~250 –≥
üî• 280‚Äì320 –∫–∫–∞–ª
–ë: 42 –≥ ¬∑ –ñ: 8 –≥ ¬∑ –£: 0 –≥

–ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è:
‚Ä¢ –î–∞–Ω–Ω—ã–µ –ø–æ –±–∞–∑–µ USDA: Chicken, broiler, breast, meat only, raw
‚Ä¢ –ü–æ—Ä—Ü–∏—è 250 –≥ (—Ä–∞—Å—á—ë—Ç –æ—Ç 100 –≥).

‚ÑπÔ∏è –û—Ü–µ–Ω–∫–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è.
‚ö†Ô∏è –û—Ü–µ–Ω–∫–∞ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è, –Ω–µ –∑–∞–º–µ–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.
```

## Accuracy & limitations

- **–ü–æ—á–µ–º—É –¥–∏–∞–ø–∞–∑–æ–Ω –∫–∞–ª–æ—Ä–∏–π:** –û—Ü–µ–Ω–∫–∞ –ø–æ—Ä—Ü–∏–∏ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–¥—É–∫—Ç—É –≤ –±–∞–∑–µ –Ω–µ—Ç–æ—á–Ω—ã–µ. –î–∏–∞–ø–∞–∑–æ–Ω (min‚Äìmax –∫–∫–∞–ª) –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–π —Ä–∞–∑–±—Ä–æ—Å: –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ —É–∂–µ (¬±15%), –ø—Ä–∏ –Ω–∏–∑–∫–æ–π ‚Äî —à–∏—Ä–µ (¬±40%). –¢–∞–∫ –º—ã —Å–Ω–∏–∂–∞–µ–º –ª–æ–∂–Ω—É—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å.
- **–ü–æ—á–µ–º—É USDA:** –ö–∞–ª–æ—Ä–∏–∏ –∏ –ë–ñ–£ –±–µ—Ä—É—Ç—Å—è –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –±–∞–∑—ã USDA FoodData Central (–Ω–∞ 100 –≥), –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –æ—Ü–µ–Ω–µ–Ω–Ω—É—é –ø–æ—Ä—Ü–∏—é. –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –æ—Ç–¥–∞—ë—Ç—Å—è —Ç–∏–ø–∞–º Foundation / SR Legacy, –∑–∞—Ç–µ–º Survey, –∑–∞—Ç–µ–º Branded. –ï—Å–ª–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø—Ä–æ–¥—É–∫—Ç–∞ —É–∫–∞–∑–∞–Ω —Ä–∞–∑–º–µ—Ä –ø–æ—Ä—Ü–∏–∏ (serving), –∞ –Ω–µ 100 –≥, –±–æ—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–º–µ—Ç–∫—É ¬´USDA values may be per serving¬ª –∏ –ø–æ–Ω–∏–∂–∞–µ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å.
- **–ö–æ–≥–¥–∞ –±—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∞:** –ë–ª—é–¥–æ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ (—Ñ–æ—Ç–æ –Ω–µ –ø–æ —Ç–µ–º–µ –∏–ª–∏ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ JSON). –ù–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ ‚Äî –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, —Ä–µ–¥–∫–∏–µ/—Å–ª–æ–∂–Ω—ã–µ –±–ª—é–¥–∞ –∏–ª–∏ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ –Ω–∞–π—Ç–∏—Å—å –≤ FDC; –ø—Ä–∏ `ENABLE_GEMINI_FALLBACK=true` –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ü–µ–Ω–∫–∞ –æ—Ç Gemini (–Ω–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å).

## Troubleshooting

**–ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç**
- –ü—Ä–æ–≤–µ—Ä—å `TELEGRAM_BOT_TOKEN` –≤ `.env` (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤/–∫–∞–≤—ã—á–µ–∫), —á—Ç–æ –∑–∞–ø—É—â–µ–Ω –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä (`npm start` –∏–ª–∏ –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏ Docker).

**409 Conflict / ¬´–∫–æ–Ω—Ñ–ª–∏–∫—Ç¬ª –ø—Ä–∏ webhook**
- Telegram –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 409, –µ—Å–ª–∏ –Ω–∞ —Ç–æ—Ç –∂–µ —Ç–æ–∫–µ–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –¥—Ä—É–≥–æ–π webhook –∏–ª–∏ long polling –≤ –¥—Ä—É–≥–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ. –ó–∞–ø—É—Å–∫–∞–π —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –Ω–∞ –æ–¥–∏–Ω —Ç–æ–∫–µ–Ω. –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—à—å —Å webhook –Ω–∞ polling (–∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç): —É–¥–∞–ª–∏ webhook —á–µ—Ä–µ–∑ BotFather –∏–ª–∏ –≤—ã–∑–æ–≤ API `deleteWebhook`, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞.

**–°–µ—Ç—å: socket hang up, ECONNRESET, —Ç–∞–π–º–∞—É—Ç—ã**
- –ù–∞ VPS –±–µ–∑ VPN –≤–æ–∑–º–æ–∂–Ω—ã –æ–±—Ä—ã–≤—ã –¥–æ Telegram –∏–ª–∏ –¥–æ API (Gemini, USDA). –ë–æ—Ç –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ Telegram –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö –∏ 5xx/429 (—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ + jitter). –ï—Å–ª–∏ –æ—à–∏–±–∫–∏ —á–∞—Å—Ç—ã–µ ‚Äî –ø—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞: `curl -I https://api.telegram.org`, –¥–æ—Å—Ç—É–ø –∫ Google/Gemini –∏ –∫ `api.nal.usda.gov`. –ü—Ä–∏ –¥–æ–ª–≥–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö —É–≤–µ–ª–∏—á—å `HTTP_TIMEOUT_MS` –∏ —É–±–µ–¥–∏—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã (—Ñ–æ—Ç–æ) –Ω–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ.

**–ö–≤–æ—Ç—ã –∏ –ª–∏–º–∏—Ç—ã (Gemini, USDA)**
- **Gemini:** –≤ –ª–æ–≥–∞—Ö `[Calorie Bot] Gemini vision error` –ø—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –∫–≤–æ—Ç—ã –∏–ª–∏ 429. –ü—Ä–æ–≤–µ—Ä—å –∫–≤–æ—Ç—ã –≤ [Google AI Studio](https://aistudio.google.com/), –ø–æ–¥–æ–∂–¥–∏ –∏–ª–∏ —Å–º–µ–Ω–∏ –º–æ–¥–µ–ª—å/–ø–ª–∞–Ω.
- **USDA:** `USDA search failed` / `food details failed` ‚Äî –ø—Ä–æ–≤–µ—Ä—å `USDA_API_KEY` –∏ [–ª–∏–º–∏—Ç—ã](https://api.data.gov/docs/rate-limits/) (–Ω–∞–ø—Ä–∏–º–µ—Ä 1000 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å). –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–∞—Ö —É–≤–µ–ª–∏—á—å `HTTP_TIMEOUT_MS`.

**¬´–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –±–ª—é–¥–æ¬ª**
- –ß—ë—Ç–∫–æ–µ —Ñ–æ—Ç–æ –æ–¥–Ω–æ–≥–æ –±–ª—é–¥–∞; –ø—Ä–∏ –Ω–µ—á–∏—Ç–∞–µ–º–æ–º –æ—Ç–≤–µ—Ç–µ Gemini (–Ω–µ JSON) –±–æ—Ç —Ç–∞–∫ –∏ –æ—Ç–≤–µ—Ç–∏—Ç. –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å `HTTP_TIMEOUT_MS`.

**¬´–ù–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –±–ª—é–¥–æ –≤ –±–∞–∑–µ¬ª**
- USDA —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∞–Ω–≥–ª–æ—è–∑—ã—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è. Gemini –æ—Ç–¥–∞—ë—Ç dish –∏ candidates –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º ‚Äî –µ—Å–ª–∏ –±–ª—é–¥–æ —Ä–µ–¥–∫–æ–µ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å FDC, –±—É–¥–µ—Ç —ç—Ç–∞ –æ—à–∏–±–∫–∞. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª—é—á–∏ `ENABLE_GEMINI_FALLBACK=true` –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ë–ñ–£ –±–µ–∑ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤ –±–∞–∑–µ.

**–û—à–∏–±–∫–∏ Gemini (—Å–µ—Ç—å / —Ä–µ–≥–∏–æ–Ω)**
- **400 "User location is not supported"** ‚Äî API Gemini –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ —Ä–µ–≥–∏–æ–Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ó–∞–ø—É—Å–∫–∞–π –±–æ—Ç–∞ –Ω–∞ VPS –≤ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ (–°–®–ê, –ï–° –∏ —Ç.–¥.) –∏–ª–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏; –∫–ª—é—á –ø—Ä–∏ —ç—Ç–æ–º –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º.
- –ü—Ä–æ–≤–µ—Ä—å `GEMINI_API_KEY` –∏ –¥–æ—Å—Ç—É–ø –∫ API Google.

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **telegraf** ‚Äî Telegram Bot API
- **@google/generative-ai** ‚Äî Gemini (vision + —Ç–µ–∫—Å—Ç–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –ë–ñ–£ –ø—Ä–∏ fallback)
- **dotenv** ‚Äî –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ `.env`
- **undici** ‚Äî HTTP keep-alive (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ Telegram –∏ USDA)

–ò—Å—Ç–æ—Ä–∏—è —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ (–±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π), –≤ MVP ‚Äî –≤ –ø–∞–º—è—Ç–∏.
